"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const constants_1 = require("../constants");
const types_1 = require("../types");
const Amqp_1 = require("../Amqp");
module.exports = function (RED) {
    function AmqpIn(config) {
        let reconnectTimeout;
        RED.events.once('flows:stopped', () => {
            clearTimeout(reconnectTimeout);
        });
        // eslint-disable-next-line @typescript-eslint/ban-ts-comment
        // @ts-ignore
        RED.nodes.createNode(this, config);
        this.status(constants_1.NODE_STATUS.Disconnected);
        const amqp = new Amqp_1.default(RED, this, config);
        (async function initializeNode(self) {
            const reconnect = () => new Promise(resolve => {
                reconnectTimeout = setTimeout(async () => {
                    try {
                        await initializeNode(self);
                        resolve();
                    }
                    catch (e) {
                        await reconnect();
                    }
                }, 2000);
            });
            try {
                const connection = await amqp.connect();
                // istanbul ignore else
                if (connection) {
                    await amqp.initialize();
                    await amqp.consume();
                    // When the node is re-deployed
                    self.once('close', async (done) => {
                        await amqp.close();
                        done && done();
                    });
                    // When the server goes down
                    connection.once('close', async (e) => {
                        e && (await reconnect());
                    });
                    self.status(constants_1.NODE_STATUS.Connected);
                }
            }
            catch (e) {
                if (e.code === types_1.ErrorType.ConnectionRefused || e.isOperational) {
                    await reconnect();
                }
                else if (e.code === types_1.ErrorType.InvalidLogin) {
                    self.status(constants_1.NODE_STATUS.Invalid);
                    self.error(`AmqpIn() Could not connect to broker ${e}`);
                }
                else {
                    self.status(constants_1.NODE_STATUS.Error);
                    self.error(`AmqpIn() ${e}`);
                }
            }
        })(this);
    }
    // eslint-disable-next-line @typescript-eslint/ban-ts-comment
    // @ts-ignore
    RED.nodes.registerType(types_1.NodeType.AmqpIn, AmqpIn);
};
